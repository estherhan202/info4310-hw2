<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>NYC Noise Complaints Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      font-size: 16px;
      background-color: #f4f7fc;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      font-family: "Impact", sans-serif;
      color: #1e3d58;
      text-transform: uppercase;
      margin-top: 40px;
      letter-spacing: 2px;
      font-size: 50px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
    }

    h2,
    .label {
      color: #4e7a8e;
      font-size: 20px;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .hidden {
      display: none;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: stretch;
      margin-top: 20px;
      width: 80%;
    }

    .info-container,
    .map-container {
      flex: 1;
      height: 600px, 100%;
    }

    .info-container {
      margin-right: 20px;
      overflow-y: scroll;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      padding: 10px;
    }

    .map-container {
      border: 2px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      padding: 2px;
    }

    .info-card {
      background-color: white;
      padding: 10px;
      border: 2px solid black;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 5px;
    }

    select#noiseType {
      padding: 10px;
      font-size: 18px;
      border-radius: 5px;
      border: 2px solid #1e3d58;
      background-color: #f0f4f8;
      color: #1e3d58;
      cursor: pointer;
      margin-right: 10px;
    }

    select#noiseType:focus {
      outline: none;
      box-shadow: 0 0 5px rgba(30, 61, 88, 0.5);
    }

    .clear-btn {
      padding: 10px 20px;
      font-size: 18px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .clear-btn:hover {
      background-color: #c0392b;
    }

    .clear-btn:active {
      background-color: #a93226;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transform: translateY(2px);
    }

    #descriptions {
      margin-left: 20px;
      font-size: 16px;
    }

    .description-container {
      width: 50%;
      margin-left: 20px;
    }

    .pie-chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 50%;
      margin-right: 20px;
    }

    .borough-description {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .borough-name {
      font-weight: bold;
      color: #1e3d58;
    }

    .borough-average {
      color: #4e7a8e;
    }

    .borough-most-common {
      font-style: italic;
      color: #8b5e3c;
    }

    #pie-chart {
      margin-top: 50px;
    }

    .tooltip {
      position: absolute;
      background-color: white;
      padding: 5px;
      border: 1px solid black;
      display: none;
    }
  </style>
</head>

<body>
  <h1>NYC Noise Complaints</h1>
  <div>
    <label for="noiseType">Filter by Noise Type:</label>
    <select id="noiseType">
      <option value="all">All</option>
    </select>
    <button class="clear-btn" id="clear-all">Clear All</button>
  </div>

  <div class="container">
    <div class="info-container" id="info-container">
      <div class="zoom-instructions">
        Scroll to Zoom & Drag to Move <br />
        Click the Dots to See and Compare Data
      </div>
    </div>

    <div class="map-container">
      <svg id="noise-map" width="600" height="600">
        <g id="map-group"></g>
      </svg>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <div class="container">
    <div class="pie-chart-container">
      <h2>Average Complaints by Borough</h2>
      <svg id="pie-chart" width="400" height="400"></svg>
    </div>
    <div class="description-container">
      <h2>Borough Descriptions</h2>
      <div id="descriptions"></div>
    </div>
  </div>



  <script>
    const width = 600;
    const height = 600;
    const svg = d3.select("#noise-map");
    const g = d3.select("#map-group");
    const tooltip = d3.select("#tooltip");
    const infoContainer = d3.select("#info-container");
    const dropdown = d3.select("#noiseType");
    const clearBtn = d3.select("#clear-all");
    let selectedDots = new Map();
    const colorScale = d3.scaleOrdinal().range([
      "#1e3d58", // Dark blue
      "#4e7a8e", // Lighter blue
      "#8b5e3c", // Warm brownish color
      "#bfa79d", // Light beige
      "#c6a6d7", // Lavender
      "#87b7c7", // Soft teal
      "#9aaf8d", // Sage green
      "#d88f3d", // Golden orange
      "#f5b73d", // Warm yellow
      "#c94d3c"  // Deep red
    ]);

    const zoom = d3
      .zoom()
      .scaleExtent([1, 10])
      .translateExtent([
        [0, 0],
        [width, height],
      ])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });


    svg.call(zoom);

    function drawNYCMap() {
      const projection = d3
        .geoMercator()
        .scale(70000)
        .center([-74, 40.7])
        .translate([width / 2, height / 2]);
      const path = d3.geoPath().projection(projection);
      d3.json("nyc.geojson").then((geojson) => {
        g.selectAll("path")
          .data(geojson.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", "white")
          .attr("stroke", "#333");
      });
    }

    drawNYCMap();

    async function loadData() {
      let data = await d3.csv("CleanedNYC311data.csv");
      const complaintTypes = Array.from(
        new Set(data.map((d) => d["Complaint Type"]))
      ).sort();
      dropdown
        .selectAll("option")
        .data(["all", ...complaintTypes])
        .enter()
        .append("option")
        .attr("value", (d) => d)
        .text((d) => d);

      function updateMap(filterType) {
        selectedDots.clear();
        // infoContainer.html("");
        let filteredData =
          filterType === "all"
            ? data
            : data.filter((d) => d["Complaint Type"] === filterType);
        const projection = d3
          .geoMercator()
          .scale(70000)
          .center([-74, 40.7])
          .translate([width / 2, height / 2]);

        g.selectAll("circle").remove();

        g.selectAll("circle")
          .data(filteredData)
          .enter()
          .append("circle")
          .attr("cx", (d) => projection([+d.Longitude, +d.Latitude])[0])
          .attr("cy", (d) => projection([+d.Longitude, +d.Latitude])[1])
          .attr("r", 2)
          .attr("fill", "gray")
          .attr("opacity", 0.7)
          .style("cursor", "pointer")
          .on("mouseover", (event, d) => {
            tooltip
              .style("display", "block")
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 10 + "px")
              .html(
                `<strong>${d["Complaint Type"]}</strong><br>${d.Descriptor}`
              );
          })
          .on("mouseout", () => tooltip.style("display", "none"))
          .on("click", function (event, d) {
            if (selectedDots.has(d)) {
              selectedDots.delete(d);
              d3.select(this).attr("fill", "gray").attr("r", 2);
            } else {
              let color = colorScale(selectedDots.size);
              selectedDots.set(d, color);
              d3.select(this)
                .attr("fill", color)
                .attr("opacity", 1)
                .attr("r", 5);
            }
            renderInfoCards();
            updateSelectedCircles();
          });

        renderInfoCards();
        updateSelectedCircles();
      }

      function updateSelectedCircles() {
        g.selectAll("circle")
          .filter((d) => selectedDots.has(d))
          .raise();
      }

      function renderInfoCards() {
        // infoContainer.html("");
        selectedDots.forEach((color, d) => {
          let card = infoContainer
            .append("div")
            .attr("class", "info-card")
            .style("border-color", color);
          card.html(`
      <button class="close-btn">x</button>
      <strong>Borough:</strong> ${d.Borough}<br>
      <strong>Complaint Type:</strong> ${d["Complaint Type"]}<br>
      <strong>Description:</strong> ${d.Descriptor}<br>
      <strong>Created Date:</strong> ${d["Created Date"]}<br>
    `);
          card.select(".close-btn").on("click", () => {
            card.remove();
            g.selectAll("circle")
              .filter((item) => item === d)
              .remove();
            selectedDots.delete(d);
            data = data.filter((item) => item !== d);
          });
        });
      }


      dropdown.on("change", function () {
        updateMap(this.value);
      });
      clearBtn.on("click", () => {
        updateMap(dropdown.property("value"));
        updateSelectedCircles();

      });

      updateMap("all");
    }

    loadData();

    async function drawPieChart() {
      let data = await d3.csv("CleanedNYC311data.csv");

      const boroughAvg = Array.from(
        d3.rollup(
          data,
          v => v.length,
          d => d.Borough
        )
      ).map(([borough, count]) => ({ key: borough, value: count }));

      const boroughMostCommon = Array.from(
        d3.rollup(
          data,
          v => d3.rollup(
            v,
            w => w.length,
            w => w["Complaint Type"]
          ),
          d => d.Borough
        )
      ).map(([borough, complaints]) => {
        const mostCommonComplaint = Array.from(complaints)
          .map(([complaintType, count]) => ({ complaintType, count }))
          .sort((a, b) => b.count - a.count)[0];
        return { borough, mostCommonComplaint };
      });

      const pie = d3.pie()
        .value(d => d.value)
        .sort(null);
      const radius = Math.min(400, 400) / 2;
      let color = colorScale.domain(boroughAvg.map(d => d.key));
      const arc = d3.arc().innerRadius(0).outerRadius(radius);

      const svg = d3.select("#pie-chart")
        .append("g")
        .attr("transform", "translate(" + radius + "," + radius + ")");

      const arcs = svg.selectAll(".arc")
        .data(pie(boroughAvg))
        .enter().append("g")
        .attr("class", "arc");

      arcs.append("path")
        .attr("d", arc)
        .attr("fill", (d, i) => color(i));

      arcs.append("text")
        .attr("transform", (d) => "translate(" + arc.centroid(d) + ")")
        .attr("dy", ".35em")
        .attr("text-anchor", "middle")
        .style("fill", "white")
        .style("font-size", "12px")
        .style("font-weight", "bold")
        .text(d => d.data.key);

      const descriptions = d3.select("#descriptions");
      descriptions.html("");

      const totalComplaints = boroughAvg.reduce((acc, d) => acc + d.value, 0);
      const averageComplaints = totalComplaints / boroughAvg.length;

      descriptions.append("div")
        .attr("class", "borough-description")
        .html(`
        <strong>Average Complaints Across All Boroughs:</strong> ${Math.round(averageComplaints)}
      `);

      boroughAvg.forEach(d => {
        const boroughData = boroughMostCommon.find(b => b.borough === d.key);
        descriptions.append("div")
          .attr("class", "borough-description")
          .html(`
          <span class="borough-name">${d.key}</span>: 
          <span class="borough-average">Total Complaints: ${d.value}</span><br>
          <span class="borough-most-common">Most Common Complaint: ${boroughData.mostCommonComplaint.complaintType} (${boroughData.mostCommonComplaint.count} complaints)</span>
        `);
      });
    }

    drawPieChart();
  </script>

</body>

</html>